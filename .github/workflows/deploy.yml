name: Deploy Agape V1 to EC2

on:
  push:
    branches: [ main, master, staging ]
    tags:
      - 'v*.*.*'  # Trigger on semantic version tags (v1.0.0, v2.1.3, etc.)
  workflow_dispatch:

env:
  AWS_REGION: eu-south-2
  ECR_REPOSITORY: agape-v1
  EC2_HOST: 51.94.1.69
  EC2_USER: ubuntu

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set environment variables
      run: |
        # Detect if this is a tag or branch
        if [[ "${{ github.ref }}" == refs/tags/v* ]]; then
          # Semantic version tag
          VERSION=${GITHUB_REF#refs/tags/v}
          MAJOR=$(echo $VERSION | cut -d. -f1)
          MINOR=$(echo $VERSION | cut -d. -f2)
          PATCH=$(echo $VERSION | cut -d. -f3)

          echo "ENVIRONMENT=production" >> $GITHUB_ENV
          echo "VERSION=v$VERSION" >> $GITHUB_ENV
          echo "VERSION_MAJOR=v$MAJOR" >> $GITHUB_ENV
          echo "VERSION_MINOR=v$MAJOR.$MINOR" >> $GITHUB_ENV
          echo "VERSION_PATCH=v$MAJOR.$MINOR.$PATCH" >> $GITHUB_ENV
          echo "IS_RELEASE=true" >> $GITHUB_ENV
          echo "IMAGE_TAG_ENV=latest" >> $GITHUB_ENV
          echo "CONTAINER_NAME=backend-v1" >> $GITHUB_ENV
          echo "HEALTH_URL=https://agape.penwin.cloud/api/v1/health" >> $GITHUB_ENV

          echo "ðŸ“¦ Release build: v$VERSION"
        elif [[ "${{ github.ref }}" == "refs/heads/staging" ]]; then
          # Staging branch
          echo "ENVIRONMENT=staging" >> $GITHUB_ENV
          echo "IMAGE_TAG_ENV=staging" >> $GITHUB_ENV
          echo "IS_RELEASE=false" >> $GITHUB_ENV
          echo "CONTAINER_NAME=backend-v1-staging" >> $GITHUB_ENV
          echo "HEALTH_URL=https://agape.penwin.cloud/api/v1-staging/health" >> $GITHUB_ENV
        else
          # Production branch (main/master)
          echo "ENVIRONMENT=production" >> $GITHUB_ENV
          echo "IMAGE_TAG_ENV=latest" >> $GITHUB_ENV
          echo "IS_RELEASE=false" >> $GITHUB_ENV
          echo "CONTAINER_NAME=backend-v1" >> $GITHUB_ENV
          echo "HEALTH_URL=https://agape.penwin.cloud/api/v1/health" >> $GITHUB_ENV
        fi

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v2
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}

    - name: Login to Amazon ECR
      id: login-ecr
      uses: aws-actions/amazon-ecr-login@v1

    - name: Build, tag, and push image to Amazon ECR
      env:
        ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
        IMAGE_TAG: ${{ github.sha }}
      run: |
        echo "ðŸ—ï¸ Building Docker image for ${{ env.ENVIRONMENT }}..."
        docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG .

        # Always tag with commit SHA
        echo "ðŸ“¦ Pushing image with SHA tag..."
        docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG

        # Tag with environment tag (latest/staging)
        docker tag $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG $ECR_REGISTRY/$ECR_REPOSITORY:${{ env.IMAGE_TAG_ENV }}
        docker push $ECR_REGISTRY/$ECR_REPOSITORY:${{ env.IMAGE_TAG_ENV }}

        echo "âœ… Images pushed:"
        echo "  - $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG"
        echo "  - $ECR_REGISTRY/$ECR_REPOSITORY:${{ env.IMAGE_TAG_ENV }}"

        # If this is a semantic version release, create version tags
        if [[ "${{ env.IS_RELEASE }}" == "true" ]]; then
          echo "ðŸ·ï¸  Creating semantic version tags..."

          # Tag with full version (v1.2.3)
          docker tag $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG $ECR_REGISTRY/$ECR_REPOSITORY:${{ env.VERSION_PATCH }}
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:${{ env.VERSION_PATCH }}

          # Tag with minor version (v1.2)
          docker tag $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG $ECR_REGISTRY/$ECR_REPOSITORY:${{ env.VERSION_MINOR }}
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:${{ env.VERSION_MINOR }}

          # Tag with major version (v1)
          docker tag $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG $ECR_REGISTRY/$ECR_REPOSITORY:${{ env.VERSION_MAJOR }}
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:${{ env.VERSION_MAJOR }}

          echo "âœ… Semantic version tags created:"
          echo "  - $ECR_REGISTRY/$ECR_REPOSITORY:${{ env.VERSION_PATCH }}"
          echo "  - $ECR_REGISTRY/$ECR_REPOSITORY:${{ env.VERSION_MINOR }}"
          echo "  - $ECR_REGISTRY/$ECR_REPOSITORY:${{ env.VERSION_MAJOR }}"
        fi

    - name: Deploy to EC2
      env:
        SSH_PRIVATE_KEY: ${{ secrets.EC2_SSH_PRIVATE_KEY }}
      run: |
        echo "$SSH_PRIVATE_KEY" > private_key.pem
        chmod 600 private_key.pem

        echo "ðŸš€ Deploying to ${{ env.ENVIRONMENT }} environment..."
        ssh -o StrictHostKeyChecking=no -i private_key.pem $EC2_USER@$EC2_HOST << 'EOF'
          # Login to ECR
          aws ecr get-login-password --region eu-south-2 | docker login --username AWS --password-stdin 635737031454.dkr.ecr.eu-south-2.amazonaws.com

          # Pull latest image
          cd /home/ubuntu/delejove-v2-backend
          docker compose pull ${{ env.CONTAINER_NAME }}

          # Deploy with zero-downtime
          docker compose up -d --no-deps ${{ env.CONTAINER_NAME }}

          # Wait for health check
          echo "â³ Waiting for container to be healthy..."
          sleep 10

          # Check if backend is healthy
          docker compose ps ${{ env.CONTAINER_NAME }} | grep -q "Up" || exit 1

          # Restart nginx if needed
          docker compose restart nginx

          # Cleanup old images
          docker image prune -af --filter "until=24h"
        EOF

        rm -f private_key.pem

    - name: Verify deployment
      run: |
        echo "ðŸ” Verifying deployment at ${{ env.HEALTH_URL }}..."
        sleep 5
        curl -f ${{ env.HEALTH_URL }} || exit 1
        echo "âœ… Deployment verified successfully!"

    - name: Deployment Summary
      run: |
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "ðŸŽ‰ Deployment to ${{ env.ENVIRONMENT }} completed!"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo ""
        echo "ðŸ“¦ Container: ${{ env.CONTAINER_NAME }}"
        echo "ðŸ·ï¸  Image Tag: ${{ env.IMAGE_TAG_ENV }}"

        if [[ "${{ env.IS_RELEASE }}" == "true" ]]; then
          echo "ðŸ“Œ Version: ${{ env.VERSION }}"
          echo "ðŸ”¢ Semantic Tags: ${{ env.VERSION_MAJOR }}, ${{ env.VERSION_MINOR }}, ${{ env.VERSION_PATCH }}"
        fi

        echo "ðŸ”— Health URL: ${{ env.HEALTH_URL }}"
        echo ""

        if [[ "${{ env.ENVIRONMENT }}" == "staging" ]]; then
          echo "ðŸ§ª Staging URL: https://agape.penwin.cloud/api/v1-staging/*"
        else
          echo "ðŸŒ Production URL: https://agape.penwin.cloud/api/v1/*"
        fi

        echo ""
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

    - name: Create GitHub Release (for version tags)
      if: env.IS_RELEASE == 'true'
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ env.VERSION }}
        release_name: Release ${{ env.VERSION }}
        body: |
          ## Agape V1 Backend - Release ${{ env.VERSION }}

          Deployed to production at `https://agape.penwin.cloud/api/v1/*`

          ### Docker Images
          - Full version: `agape-v1:${{ env.VERSION_PATCH }}`
          - Minor version: `agape-v1:${{ env.VERSION_MINOR }}`
          - Major version: `agape-v1:${{ env.VERSION_MAJOR }}`
          - Latest: `agape-v1:latest`
          - Commit SHA: `agape-v1:${{ github.sha }}`

          ### Deployment Info
          - Environment: Production
          - Container: `backend-v1`
          - Health check: https://agape.penwin.cloud/api/v1/health
        draft: false
        prerelease: false

    - name: Notify on failure
      if: failure()
      run: |
        echo "âŒ Deployment to ${{ env.ENVIRONMENT }} failed!"
