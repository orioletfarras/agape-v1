name: Deploy Agape V1 to EC2

on:
  push:
    branches: [ main, master, staging ]
  workflow_dispatch:

env:
  AWS_REGION: eu-south-2
  ECR_REPOSITORY: agape-v1
  EC2_HOST: 51.94.1.69
  EC2_USER: ubuntu

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set environment variables
      run: |
        if [[ "${{ github.ref }}" == "refs/heads/staging" ]]; then
          echo "ENVIRONMENT=staging" >> $GITHUB_ENV
          echo "IMAGE_TAG_ENV=staging" >> $GITHUB_ENV
          echo "CONTAINER_NAME=backend-v1-staging" >> $GITHUB_ENV
          echo "HEALTH_URL=https://agape.penwin.cloud/api/v1-staging/health" >> $GITHUB_ENV
        else
          echo "ENVIRONMENT=production" >> $GITHUB_ENV
          echo "IMAGE_TAG_ENV=latest" >> $GITHUB_ENV
          echo "CONTAINER_NAME=backend-v1" >> $GITHUB_ENV
          echo "HEALTH_URL=https://agape.penwin.cloud/api/v1/health" >> $GITHUB_ENV
        fi

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v2
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}

    - name: Login to Amazon ECR
      id: login-ecr
      uses: aws-actions/amazon-ecr-login@v1

    - name: Build, tag, and push image to Amazon ECR
      env:
        ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
        IMAGE_TAG: ${{ github.sha }}
      run: |
        echo "ðŸ—ï¸ Building Docker image for ${{ env.ENVIRONMENT }}..."
        docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG .
        docker tag $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG $ECR_REGISTRY/$ECR_REPOSITORY:${{ env.IMAGE_TAG_ENV }}

        echo "ðŸ“¦ Pushing images to ECR..."
        docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
        docker push $ECR_REGISTRY/$ECR_REPOSITORY:${{ env.IMAGE_TAG_ENV }}

        echo "âœ… Images pushed successfully:"
        echo "  - $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG"
        echo "  - $ECR_REGISTRY/$ECR_REPOSITORY:${{ env.IMAGE_TAG_ENV }}"

    - name: Deploy to EC2
      env:
        SSH_PRIVATE_KEY: ${{ secrets.EC2_SSH_PRIVATE_KEY }}
      run: |
        echo "$SSH_PRIVATE_KEY" > private_key.pem
        chmod 600 private_key.pem

        echo "ðŸš€ Deploying to ${{ env.ENVIRONMENT }} environment..."
        ssh -o StrictHostKeyChecking=no -i private_key.pem $EC2_USER@$EC2_HOST << 'EOF'
          # Login to ECR
          aws ecr get-login-password --region eu-south-2 | docker login --username AWS --password-stdin 635737031454.dkr.ecr.eu-south-2.amazonaws.com

          # Pull latest image
          cd /home/ubuntu/delejove-v2-backend
          docker compose pull ${{ env.CONTAINER_NAME }}

          # Deploy with zero-downtime
          docker compose up -d --no-deps ${{ env.CONTAINER_NAME }}

          # Wait for health check
          echo "â³ Waiting for container to be healthy..."
          sleep 10

          # Check if backend is healthy
          docker compose ps ${{ env.CONTAINER_NAME }} | grep -q "Up" || exit 1

          # Restart nginx if needed
          docker compose restart nginx

          # Cleanup old images
          docker image prune -af --filter "until=24h"
        EOF

        rm -f private_key.pem

    - name: Verify deployment
      run: |
        echo "ðŸ” Verifying deployment at ${{ env.HEALTH_URL }}..."
        sleep 5
        curl -f ${{ env.HEALTH_URL }} || exit 1
        echo "âœ… Deployment verified successfully!"

    - name: Deployment Summary
      run: |
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "ðŸŽ‰ Deployment to ${{ env.ENVIRONMENT }} completed!"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo ""
        echo "ðŸ“¦ Container: ${{ env.CONTAINER_NAME }}"
        echo "ðŸ·ï¸  Image Tag: ${{ env.IMAGE_TAG_ENV }}"
        echo "ðŸ”— Health URL: ${{ env.HEALTH_URL }}"
        echo ""
        if [[ "${{ env.ENVIRONMENT }}" == "staging" ]]; then
          echo "ðŸ§ª Staging URL: https://agape.penwin.cloud/api/v1-staging/*"
        else
          echo "ðŸŒ Production URL: https://agape.penwin.cloud/api/v1/*"
        fi
        echo ""
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

    - name: Notify on failure
      if: failure()
      run: |
        echo "âŒ Deployment to ${{ env.ENVIRONMENT }} failed!"
